<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://stephenc.github.io/js/theme-mode.js></script><link rel=stylesheet href=https://stephenc.github.io/css/frameworks.min.css><link rel=stylesheet href=https://stephenc.github.io/css/github.min.css><link rel=stylesheet href=https://stephenc.github.io/css/github-style.css><link rel=stylesheet href=https://stephenc.github.io/css/light.css><link rel=stylesheet href=https://stephenc.github.io/css/dark.css><link rel=stylesheet href=https://stephenc.github.io/css/syntax.css><title>Apache 2.2 Authentication with Active Directory via Cyrus SASL - Stephen's technical blog</title>
<link rel=icon type=image/x-icon href=https://stephenc.github.io/images/favicon.ico><meta name=theme-color content="#1e2327"><meta name=description content='Here is my version of the holy grail, i.e.Authentication for Apache HTTPD against Active Directory.This is not the only way to skin this cat, for example you could also use Sander Marechal&rsquo;s technique (which uses mod_authnz_ldap). However, my problem with Sander&rsquo;s technique is that you need to have an account in Active Directory which you will use to bind to the LDAP server. That means that the accound password has to be stored in a plain-text file on the Apache server, and if the password expires everything breaks until you go fix the password.I want as near to zero maintenance as possible, running on CentOS 5.2 with minimal custom work - so that I don&rsquo;t have to maintain it when it does break.I have previously configured Kerberos to authenicate against Active Directory, so my first attempt was with mod_auth_kerb. That worked&mldr; but very slowly&mldr; trying to an empty access Subversion repository took over 2 minutes. The problem being that successful authentication was not being cached.Then I tried using mod_perl and the Authen::Simple::ActiveDirectory reasoning that I could always hack caching once in perl&mldr; but getting that lot installed on a CentOS 5.2 from RPMs was an exercise in tears.So, anyway, I found out that Cyrus SASL supports two modes of LDAP authentication:The bind method uses the LDAP bind facility to verify the password. The bind method is not available when ldap_use_sasl is turned on. In that case saslauthd will use fastbind.&lsquo;bind&rsquo; is the default auth method. When ldap_use_sasl is enabled, &lsquo;fastbind&rsquo; is the default.The custom method uses userPassword attribute to verify the password. Suppored hashes: crypt, md5, smd5, sha and ssha. Cleartext is supported as well.The fastbind method (when &rsquo;ldap_use_sasl: no&rsquo;) does away with the search and an extra anonymous bind in auth_bind, but makes two assumptions: 1. Expanding the ldap_filter expression gives the user&rsquo;s fully-qualified DN 2. There is no cost to staying bound as a named userSo bind is pretty much the same technique as that used by mod_authnz_ldap, and (as ActiveDirectory does not support - at my company at least - anonymous bind) is ruled out of the running.&ldquo;fastbind&rdquo; sounds exactly like what I want&mldr; ok and saslauthd can be configured to cache authentication, so none of the performance hit of mod_auth_kerb. All we need is a way to tie this into Apache.So, enter mod_authn_sasl which does just that.First, we need to create an RPM, so I did a quicksudo yum install httpd-devel rpmbuild mocksudoecho &ldquo;%_topdir %(echo $HOME)/rpmbuild&rdquo; > ~/.rpmmacrosmkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}I added my account to the mock group, logged out and in again for the group membership to be recognised and I was ready to go. This was my first experience playing with mock, but it was lovely, especially as CentOS has its own version.I pre-primed my mock environments for i386 and x86_64 as I need RPMs for both of these:mock -r centos-5-i386 initmock -r centos-5-x86_64 initThen I downloaded mod_authn_sasl-1.0.2.tar.bz2 and started writing my spec file.You can download the RPC spec: mod_authn_sasl.spec and the apache config file: mod_authn_sasl.conf.I put mod_authn_sasl-1.0.2.tar.bz2 and mod_authn_sasl.conf in the ~/rpmbuild/SOURCES and then runningrpmbuild -ba mod_authn_sasl.specproduced my source RPM, then I used mock to create the two binary RPMs that I needed:mock -r centos-5-i386 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmmock -r centos-5-x86_64 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmThe rpms built from the mock environments end up in /var/lib/mock/centos-5-i386/result and /var/lib/mock/centos-5-x86_64/result. If you want to be lazy and trust my binaries here they are:mod_authn_sasl-1.0.2-4.i386.rpmmod_authn_sasl-1.0.2-4.x86_64.rpmNow all we need to do is configure everything.I&rsquo;ve written this shell script to simplify configuring saslauthd for most good deployments of Active Directory, i.e. where there are SRV records for the domain in your DNS server. You need to run it as root. It looks up the SRV records for the domain name you provide, and creates /etc/saslauthd.conf from them, assuming that the Active Directory domain name is the first word of your DNS name converted to uppercase. So for example, if your Active Directory is set up correctly, and you can login to windows as either EXAMPLE\joebloggs or jbloggs@example.foo.com then you would runsh system-saslauthd-active-directory-config.sh example.foo.comAnd that should setup saslauthd for you. You can test this using the testsaslauthd program.Then all you need to do is secure the appropriate locations in apache, e.g. by adding the following to your VirtualHost configuration:<Location /private>AuthSaslPwcheckMethod saslauthdAuthSaslAppname httpdAuthSaslRealm exampleAuthType basicAuthBasicProvider saslAuthBasicAuthoritative OnAuthName &ldquo;sasl@example.com"require valid-userAnd define the SASL application provider for the AuthSaslAppname you specified, e.g. for the above configuration you need to create /usr/lib/sasl2/httpd.conf with the contents:pwcheck_method:saslauthdThat&rsquo;s it. You should be done.Updated Friday 28th November 2008: I noticed that the spec file I had provided did not have the correct Requires and BuildRequires. I have fixed this and now I have posted updated rpms (these are 1.0.2-4) with the correct requires to help with a minimal install
'><meta name=keywords content='blog'><meta name=robots content="noodp"><link rel=canonical href=https://stephenc.github.io/post/2008-11-01-apache-22-authentication-with-active-directory-via-cyrus-sasl/><meta name=twitter:card content="summary"><meta name=twitter:title content="Apache 2.2 Authentication with Active Directory via Cyrus SASL - Stephen's technical blog"><meta name=twitter:description content='Here is my version of the holy grail, i.e.Authentication for Apache HTTPD against Active Directory.This is not the only way to skin this cat, for example you could also use Sander Marechal&rsquo;s technique (which uses mod_authnz_ldap). However, my problem with Sander&rsquo;s technique is that you need to have an account in Active Directory which you will use to bind to the LDAP server. That means that the accound password has to be stored in a plain-text file on the Apache server, and if the password expires everything breaks until you go fix the password.I want as near to zero maintenance as possible, running on CentOS 5.2 with minimal custom work - so that I don&rsquo;t have to maintain it when it does break.I have previously configured Kerberos to authenicate against Active Directory, so my first attempt was with mod_auth_kerb. That worked&mldr; but very slowly&mldr; trying to an empty access Subversion repository took over 2 minutes. The problem being that successful authentication was not being cached.Then I tried using mod_perl and the Authen::Simple::ActiveDirectory reasoning that I could always hack caching once in perl&mldr; but getting that lot installed on a CentOS 5.2 from RPMs was an exercise in tears.So, anyway, I found out that Cyrus SASL supports two modes of LDAP authentication:The bind method uses the LDAP bind facility to verify the password. The bind method is not available when ldap_use_sasl is turned on. In that case saslauthd will use fastbind.&lsquo;bind&rsquo; is the default auth method. When ldap_use_sasl is enabled, &lsquo;fastbind&rsquo; is the default.The custom method uses userPassword attribute to verify the password. Suppored hashes: crypt, md5, smd5, sha and ssha. Cleartext is supported as well.The fastbind method (when &rsquo;ldap_use_sasl: no&rsquo;) does away with the search and an extra anonymous bind in auth_bind, but makes two assumptions: 1. Expanding the ldap_filter expression gives the user&rsquo;s fully-qualified DN 2. There is no cost to staying bound as a named userSo bind is pretty much the same technique as that used by mod_authnz_ldap, and (as ActiveDirectory does not support - at my company at least - anonymous bind) is ruled out of the running.&ldquo;fastbind&rdquo; sounds exactly like what I want&mldr; ok and saslauthd can be configured to cache authentication, so none of the performance hit of mod_auth_kerb. All we need is a way to tie this into Apache.So, enter mod_authn_sasl which does just that.First, we need to create an RPM, so I did a quicksudo yum install httpd-devel rpmbuild mocksudoecho &ldquo;%_topdir %(echo $HOME)/rpmbuild&rdquo; > ~/.rpmmacrosmkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}I added my account to the mock group, logged out and in again for the group membership to be recognised and I was ready to go. This was my first experience playing with mock, but it was lovely, especially as CentOS has its own version.I pre-primed my mock environments for i386 and x86_64 as I need RPMs for both of these:mock -r centos-5-i386 initmock -r centos-5-x86_64 initThen I downloaded mod_authn_sasl-1.0.2.tar.bz2 and started writing my spec file.You can download the RPC spec: mod_authn_sasl.spec and the apache config file: mod_authn_sasl.conf.I put mod_authn_sasl-1.0.2.tar.bz2 and mod_authn_sasl.conf in the ~/rpmbuild/SOURCES and then runningrpmbuild -ba mod_authn_sasl.specproduced my source RPM, then I used mock to create the two binary RPMs that I needed:mock -r centos-5-i386 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmmock -r centos-5-x86_64 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmThe rpms built from the mock environments end up in /var/lib/mock/centos-5-i386/result and /var/lib/mock/centos-5-x86_64/result. If you want to be lazy and trust my binaries here they are:mod_authn_sasl-1.0.2-4.i386.rpmmod_authn_sasl-1.0.2-4.x86_64.rpmNow all we need to do is configure everything.I&rsquo;ve written this shell script to simplify configuring saslauthd for most good deployments of Active Directory, i.e. where there are SRV records for the domain in your DNS server. You need to run it as root. It looks up the SRV records for the domain name you provide, and creates /etc/saslauthd.conf from them, assuming that the Active Directory domain name is the first word of your DNS name converted to uppercase. So for example, if your Active Directory is set up correctly, and you can login to windows as either EXAMPLE\joebloggs or jbloggs@example.foo.com then you would runsh system-saslauthd-active-directory-config.sh example.foo.comAnd that should setup saslauthd for you. You can test this using the testsaslauthd program.Then all you need to do is secure the appropriate locations in apache, e.g. by adding the following to your VirtualHost configuration:<Location /private>AuthSaslPwcheckMethod saslauthdAuthSaslAppname httpdAuthSaslRealm exampleAuthType basicAuthBasicProvider saslAuthBasicAuthoritative OnAuthName &ldquo;sasl@example.com"require valid-userAnd define the SASL application provider for the AuthSaslAppname you specified, e.g. for the above configuration you need to create /usr/lib/sasl2/httpd.conf with the contents:pwcheck_method:saslauthdThat&rsquo;s it. You should be done.Updated Friday 28th November 2008: I noticed that the spec file I had provided did not have the correct Requires and BuildRequires. I have fixed this and now I have posted updated rpms (these are 1.0.2-4) with the correct requires to help with a minimal install
'><meta name=twitter:site content="https://stephenc.github.io/"><meta name=twitter:creator content><meta name=twitter:image content="https://stephenc.github.io/"><meta property="og:type" content="article"><meta property="og:title" content="Apache 2.2 Authentication with Active Directory via Cyrus SASL - Stephen's technical blog"><meta property="og:description" content='Here is my version of the holy grail, i.e.Authentication for Apache HTTPD against Active Directory.This is not the only way to skin this cat, for example you could also use Sander Marechal&rsquo;s technique (which uses mod_authnz_ldap). However, my problem with Sander&rsquo;s technique is that you need to have an account in Active Directory which you will use to bind to the LDAP server. That means that the accound password has to be stored in a plain-text file on the Apache server, and if the password expires everything breaks until you go fix the password.I want as near to zero maintenance as possible, running on CentOS 5.2 with minimal custom work - so that I don&rsquo;t have to maintain it when it does break.I have previously configured Kerberos to authenicate against Active Directory, so my first attempt was with mod_auth_kerb. That worked&mldr; but very slowly&mldr; trying to an empty access Subversion repository took over 2 minutes. The problem being that successful authentication was not being cached.Then I tried using mod_perl and the Authen::Simple::ActiveDirectory reasoning that I could always hack caching once in perl&mldr; but getting that lot installed on a CentOS 5.2 from RPMs was an exercise in tears.So, anyway, I found out that Cyrus SASL supports two modes of LDAP authentication:The bind method uses the LDAP bind facility to verify the password. The bind method is not available when ldap_use_sasl is turned on. In that case saslauthd will use fastbind.&lsquo;bind&rsquo; is the default auth method. When ldap_use_sasl is enabled, &lsquo;fastbind&rsquo; is the default.The custom method uses userPassword attribute to verify the password. Suppored hashes: crypt, md5, smd5, sha and ssha. Cleartext is supported as well.The fastbind method (when &rsquo;ldap_use_sasl: no&rsquo;) does away with the search and an extra anonymous bind in auth_bind, but makes two assumptions: 1. Expanding the ldap_filter expression gives the user&rsquo;s fully-qualified DN 2. There is no cost to staying bound as a named userSo bind is pretty much the same technique as that used by mod_authnz_ldap, and (as ActiveDirectory does not support - at my company at least - anonymous bind) is ruled out of the running.&ldquo;fastbind&rdquo; sounds exactly like what I want&mldr; ok and saslauthd can be configured to cache authentication, so none of the performance hit of mod_auth_kerb. All we need is a way to tie this into Apache.So, enter mod_authn_sasl which does just that.First, we need to create an RPM, so I did a quicksudo yum install httpd-devel rpmbuild mocksudoecho &ldquo;%_topdir %(echo $HOME)/rpmbuild&rdquo; > ~/.rpmmacrosmkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}I added my account to the mock group, logged out and in again for the group membership to be recognised and I was ready to go. This was my first experience playing with mock, but it was lovely, especially as CentOS has its own version.I pre-primed my mock environments for i386 and x86_64 as I need RPMs for both of these:mock -r centos-5-i386 initmock -r centos-5-x86_64 initThen I downloaded mod_authn_sasl-1.0.2.tar.bz2 and started writing my spec file.You can download the RPC spec: mod_authn_sasl.spec and the apache config file: mod_authn_sasl.conf.I put mod_authn_sasl-1.0.2.tar.bz2 and mod_authn_sasl.conf in the ~/rpmbuild/SOURCES and then runningrpmbuild -ba mod_authn_sasl.specproduced my source RPM, then I used mock to create the two binary RPMs that I needed:mock -r centos-5-i386 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmmock -r centos-5-x86_64 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmThe rpms built from the mock environments end up in /var/lib/mock/centos-5-i386/result and /var/lib/mock/centos-5-x86_64/result. If you want to be lazy and trust my binaries here they are:mod_authn_sasl-1.0.2-4.i386.rpmmod_authn_sasl-1.0.2-4.x86_64.rpmNow all we need to do is configure everything.I&rsquo;ve written this shell script to simplify configuring saslauthd for most good deployments of Active Directory, i.e. where there are SRV records for the domain in your DNS server. You need to run it as root. It looks up the SRV records for the domain name you provide, and creates /etc/saslauthd.conf from them, assuming that the Active Directory domain name is the first word of your DNS name converted to uppercase. So for example, if your Active Directory is set up correctly, and you can login to windows as either EXAMPLE\joebloggs or jbloggs@example.foo.com then you would runsh system-saslauthd-active-directory-config.sh example.foo.comAnd that should setup saslauthd for you. You can test this using the testsaslauthd program.Then all you need to do is secure the appropriate locations in apache, e.g. by adding the following to your VirtualHost configuration:<Location /private>AuthSaslPwcheckMethod saslauthdAuthSaslAppname httpdAuthSaslRealm exampleAuthType basicAuthBasicProvider saslAuthBasicAuthoritative OnAuthName &ldquo;sasl@example.com"require valid-userAnd define the SASL application provider for the AuthSaslAppname you specified, e.g. for the above configuration you need to create /usr/lib/sasl2/httpd.conf with the contents:pwcheck_method:saslauthdThat&rsquo;s it. You should be done.Updated Friday 28th November 2008: I noticed that the spec file I had provided did not have the correct Requires and BuildRequires. I have fixed this and now I have posted updated rpms (these are 1.0.2-4) with the correct requires to help with a minimal install
'><meta property="og:url" content="https://stephenc.github.io/post/2008-11-01-apache-22-authentication-with-active-directory-via-cyrus-sasl/"><meta property="og:site_name" content="Apache 2.2 Authentication with Active Directory via Cyrus SASL"><meta property="og:image" content="https://stephenc.github.io/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2008-11-01 00:00:00 +0000 UTC"></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://stephenc.github.io/><img class=octicon height=32 width=32 src=/images/gitHub-mark-white.png></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick='document.querySelector("#header-search").style.display=document.querySelector("#header-search").style.display=="none"?"block":"none"'><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank id=search-form accept-charset=UTF-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://stephenc.github.io/><img class="octicon octicon-mark-github v-align-middle" height=32 width=32 src=/images/gitHub-mark-white.png></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div id=search-result class="container-lg px-3 new-discussion-timeline" style=display:none></div><div class=application-main><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://stephenc.github.io/><img class=avatar-user src=/images/avatar.jpg width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://stephenc.github.io/>stephenc</a>
</span><span class=path-divider>/</span>
<strong class="css-truncate css-truncate-target mr-1" style=max-width:410px><a href=https://stephenc.github.io/post/2008-11-01-apache-22-authentication-with-active-directory-via-cyrus-sasl/>Apache 2.2 Authentication with Active Directory via Cyrus SASL</a></strong></h1><div class="note m-0">Created <relative-time datetime="Sat, 01 Nov 2008 00:00:00 +0000" class=no-wrap>Sat, 01 Nov 2008 00:00:00 +0000</relative-time>
<span class=file-info-divider></span>
Modified <relative-time datetime="Sat, 01 Nov 2008 00:00:00 +0000" class=no-wrap>Sat, 01 Nov 2008 00:00:00 +0000</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div id=post-header class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style=z-index:2><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0"><summary id=toc-toggle onclick=clickToc() class="btn btn-octicon m-0 mr-2 p-2"><svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered"><path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zm0 5a.75.75.0 000 1.5h8.5a.75.75.0 000-1.5h-8.5zM3 8A1 1 0 111 8a1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"/></svg></summary><details-menu class=SelectMenu id=toc-details style="display: none;"><div class="SelectMenu-modal rounded-3 mt-1" style=max-height:340px><div class="SelectMenu-list SelectMenu-list--borderless p-2" style=overscroll-behavior:contain id=toc-list></div></div></details-menu>783 Words</div><div class="file-actions flex-order-2 pt-0"></div></div></div><div class="Box-body px-5 pb-5" style=z-index:1><article class="markdown-body entry-content container-lg"><p>Here is my version of the holy grail, i.e.Authentication for Apache HTTPD against Active Directory.This is not the only way to skin this cat, for example you could also use Sander Marechal&rsquo;s technique (which uses mod_authnz_ldap). However, my problem with Sander&rsquo;s technique is that you need to have an account in Active Directory which you will use to bind to the LDAP server. That means that the accound password has to be stored in a plain-text file on the Apache server, and if the password expires everything breaks until you go fix the password.I want as near to zero maintenance as possible, running on CentOS 5.2 with minimal custom work - so that I don&rsquo;t have to maintain it when it does break.I have previously configured Kerberos to authenicate against Active Directory, so my first attempt was with mod_auth_kerb. That worked&mldr; but very slowly&mldr; trying to an empty access Subversion repository took over 2 minutes. The problem being that successful authentication was not being cached.Then I tried using mod_perl and the Authen::Simple::ActiveDirectory reasoning that I could always hack caching once in perl&mldr; but getting that lot installed on a CentOS 5.2 from RPMs was an exercise in tears.So, anyway, I found out that Cyrus SASL supports two modes of LDAP authentication:The bind method uses the LDAP bind facility to verify the password. The bind method is not available when ldap_use_sasl is turned on. In that case saslauthd will use fastbind.&lsquo;bind&rsquo; is the default auth method. When ldap_use_sasl is enabled, &lsquo;fastbind&rsquo; is the default.The custom method uses userPassword attribute to verify the password. Suppored hashes: crypt, md5, smd5, sha and ssha. Cleartext is supported as well.The fastbind method (when &rsquo;ldap_use_sasl: no&rsquo;) does away with the search and an extra anonymous bind in auth_bind, but makes two assumptions: 1. Expanding the ldap_filter expression gives the user&rsquo;s fully-qualified DN 2. There is no cost to staying bound as a named userSo bind is pretty much the same technique as that used by mod_authnz_ldap, and (as ActiveDirectory does not support - at my company at least - anonymous bind) is ruled out of the running.&ldquo;fastbind&rdquo; sounds exactly like what I want&mldr; ok and saslauthd can be configured to cache authentication, so none of the performance hit of mod_auth_kerb. All we need is a way to tie this into Apache.So, enter mod_authn_sasl which does just that.First, we need to create an RPM, so I did a quicksudo yum install httpd-devel rpmbuild mocksudoecho &ldquo;%_topdir %(echo $HOME)/rpmbuild&rdquo; > ~/.rpmmacrosmkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}I added my account to the mock group, logged out and in again for the group membership to be recognised and I was ready to go. This was my first experience playing with mock, but it was lovely, especially as CentOS has its own version.I pre-primed my mock environments for i386 and x86_64 as I need RPMs for both of these:mock -r centos-5-i386 initmock -r centos-5-x86_64 initThen I downloaded mod_authn_sasl-1.0.2.tar.bz2 and started writing my spec file.You can download the RPC spec: mod_authn_sasl.spec and the apache config file: mod_authn_sasl.conf.I put mod_authn_sasl-1.0.2.tar.bz2 and mod_authn_sasl.conf in the ~/rpmbuild/SOURCES and then runningrpmbuild -ba mod_authn_sasl.specproduced my source RPM, then I used mock to create the two binary RPMs that I needed:mock -r centos-5-i386 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmmock -r centos-5-x86_64 ~/rpmbuild/SRPMS/mod_authn_sasl-1.0.2-4.src.rpmThe rpms built from the mock environments end up in /var/lib/mock/centos-5-i386/result and /var/lib/mock/centos-5-x86_64/result. If you want to be lazy and trust my binaries here they are:mod_authn_sasl-1.0.2-4.i386.rpmmod_authn_sasl-1.0.2-4.x86_64.rpmNow all we need to do is configure everything.I&rsquo;ve written this shell script to simplify configuring saslauthd for most good deployments of Active Directory, i.e. where there are SRV records for the domain in your DNS server. You need to run it as root. It looks up the SRV records for the domain name you provide, and creates /etc/saslauthd.conf from them, assuming that the Active Directory domain name is the first word of your DNS name converted to uppercase. So for example, if your Active Directory is set up correctly, and you can login to windows as either EXAMPLE\joebloggs or <a href=mailto:jbloggs@example.foo.com>jbloggs@example.foo.com</a> then you would runsh system-saslauthd-active-directory-config.sh example.foo.comAnd that should setup saslauthd for you. You can test this using the testsaslauthd program.Then all you need to do is secure the appropriate locations in apache, e.g. by adding the following to your VirtualHost configuration:&lt;Location /private>AuthSaslPwcheckMethod saslauthdAuthSaslAppname httpdAuthSaslRealm exampleAuthType basicAuthBasicProvider saslAuthBasicAuthoritative OnAuthName &ldquo;<a href=mailto:sasl@example.com>sasl@example.com</a>"require valid-userAnd define the SASL application provider for the AuthSaslAppname you specified, e.g. for the above configuration you need to create /usr/lib/sasl2/httpd.conf with the contents:pwcheck_method:saslauthdThat&rsquo;s it. You should be done.Updated Friday 28th November 2008: I noticed that the spec file I had provided did not have the correct Requires and BuildRequires. I have fixed this and now I have posted updated rpms (these are 1.0.2-4) with the correct requires to help with a minimal install</p></article></div></div></div></div></div></div></main></div><script type=application/javascript src=https://stephenc.github.io/js/toc.js></script><link rel=stylesheet href=https://stephenc.github.io/css/toc.css></div><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://stephenc.github.io/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li><li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href=https://github.com/>GitHub, Inc.</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://stephenc.github.io/js/github-style.js></script><script src=https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js></script><script type=application/javascript src=https://stephenc.github.io/js/search.js></script></html>